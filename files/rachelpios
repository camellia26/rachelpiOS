#!/bin/bash

set -o errexit
set -o nounset

sudo apt-get update
sudo rpi-update
sudo apt-get -y dist-upgrade


#create wifi hotspot
sudo apt-get -y install hostapd udhcpd
sudo cp udhcpd.conf /etc/udhcpd.conf
sudo cp udhcpd /etc/default/udhcpd
sudo cp hostapd /etc/default/hostapd
sudo cp interfaces /etc/network/interfaces
sudo cp hostapd.conf /etc/hostapd/hostapd.conf
sudo sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"
sudo cp sysctl.conf /etc/sysctl.conf
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
sudo sh -c "iptables-save > /etc/iptables.ipv4.nat"

# this script should be able to run if the wifi is not present
if ! ifconfig wlan0; then
    echo "Wifi device not present; skipping."
else
    sudo ifconfig wlan0 10.10.10.10
    sudo service hostapd start
    sudo service udhcpd start
    sudo update-rc.d hostapd enable
    sudo update-rc.d udhcpd enable
    ./ifupdown.sh
fi

#install apache php mysql
sudo apt-get -y install apache2 libapache2-mod-proxy-html libxml2-dev \
     php5-common libapache2-mod-php5 php5-cgi php5 \
     mysql-server mysql-client php5-mysql
sudo cp default /etc/apache2/sites-enabled/default
sudo cp my.cnf /etc/mysql/my.cnf
sudo a2enmod php5 proxy proxy_html rewrite # TODO: is this all that's needed?
sudo service apache2 restart

#update hostname
sudo cp hosts /etc/hosts
sudo cp hostname /etc/hostname
sudo /etc/init.d/hostname.sh

#install shamba share
sudo apt-get -y install samba samba-common-bin
sudo mkdir -p /var/www/local
sudo chmod 777 /var/www/local
sudo cp smb.conf /etc/samba/smb.conf
# sudo cp dhcp.conf /etc/samba/dhcp.conf
sudo cp gdbcommands /etc/samba/gdbcommands

#install h5ai
# TODO: figure out how to download package
# mkdir -p /var/www/_h5ai
# sudo cp default /etc/apache2/sites-available/default
# sudo apt-get -y install php5-gd ffmpeg zip imagemagick
# sudo chmod 777 -R /var/www/_h5ai/cache/

#install base www files
sudo rm -f /var/www/index.html
sudo cp -r www/* /var/www/

#put realtek drivers in place if needed
sudo cp hostapd_RTL8188CUS /home/pi/hostapd_RTL
sudo cp realtek.sh /home/pi/Desktop/realtek.sh
sudo cp hostapd_realtek.conf /home/pi/hostapd_realtek.conf

#redo wifi enable for good measure
if ifconfig wlan0; then
    sudo ifconfig wlan0 10.10.10.10
    sudo service hostapd start
    sudo service udhcpd start
    sudo update-rc.d hostapd enable
    sudo update-rc.d udhcpd enable
fi

#install kiwix
# download kiwix-server-0.9-rc2-linux-armv5tejl.tar.bz2
# tar -xjvf above file

echo "Setup complete."

